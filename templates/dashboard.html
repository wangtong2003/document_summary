<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档摘要生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --sidebar-width: 320px;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            color: var(--primary-color);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .main-content {
            flex: 1;
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #chatBody {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .chat-message {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 100%;
            padding: 1.5rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.8;
        }

        .markdown-body p {
            margin: 1.2em 0;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            margin-top: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-body ul, .markdown-body ol {
            margin: 1em 0;
            padding-left: 1.5em;
        }

        .markdown-body li {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        .markdown-body pre {
            margin: 1.2em 0;
            padding: 1em;
            background-color: #f8fafc;
            border-radius: 8px;
            overflow-x: auto;
        }

        .markdown-body code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            background-color: #f3f4f6;
        }

        .markdown-body pre code {
            display: block;
            padding: 0;
            background-color: transparent;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.6;
        }

        .markdown-body blockquote {
            margin: 1.2em 0;
            padding: 0.8em 1em;
            border-left: 4px solid #3b82f6;
            background-color: #f3f4f6;
            color: #4b5563;
            border-radius: 4px;
        }

        .markdown-body strong {
            color: #1a56db;
            font-weight: 600;
        }

        .markdown-body em {
            color: #2563eb;
            font-style: italic;
        }

        .upload-area {
            background: #ffffff;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 2.5rem 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: #fafafa;
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background-color: #f8fafc;
        }

        .upload-icon {
            color: #9ca3af;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #4b5563;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .file-types {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .file-type {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .file-type:not(:last-child):after {
            content: "•";
            margin: 0 0.5rem;
            color: #d1d5db;
        }

        .btn-upload {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-upload:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .file-preview {
            position: relative;
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #ffffff;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
            transition: all 0.2s ease;
        }

        .file-preview:hover {
            background: #f8fafc;
        }

        .file-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .file-preview-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            gap: 0.5rem;
        }

        .file-preview-title {
            color: #374151;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .file-preview-title:hover {
            background-color: #f3f4f6;
        }

        .file-preview-size {
            color: #6b7280;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .file-preview-remove {
            color: #9ca3af;
            background: none;
            border: none;
            padding: 0.25rem;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .file-preview:hover .file-preview-remove {
            opacity: 1;
        }

        .file-preview-remove:hover {
            color: #ef4444;
        }

        .file-icon {
            color: #6b7280;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .progress {
            height: 6px;
            border-radius: 3px;
            background-color: #f1f5f9;
            margin-top: 0.5rem;
        }

        .progress-bar {
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-select:hover {
            border-color: #d1d5db;
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .message {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 0.3rem;
            margin-bottom: 0.3rem;
            border: 1px solid #e5e7eb;
        }

        .nav-link {
            display: inline-block;
            padding: 0.5rem 1rem;
            color: #6b7280;
            text-decoration: none;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--primary-color);
            background-color: #f3f4f6;
        }

        #adminPanel {
            display: none; /* 默认隐藏管理面板 */
            text-decoration: none;
            color: #6b7280;
        }

        #adminPanel:hover {
            color: var(--primary-color);
        }

        #logoutBtn {
            cursor: pointer;
            text-decoration: none;
        }

        #logoutBtn:hover {
            background-color: #f3f4f6;
        }

        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #374151;
            overflow-wrap: break-word;
            word-break: break-word;
            padding: 20px;
        }

        .markdown-content h1 {
            font-size: 24px;
            margin: 24px 0 16px;
            font-weight: 600;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 20px;
            margin: 20px 0 16px;
            font-weight: 600;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .markdown-content h3 {
            font-size: 18px;
            margin: 16px 0 12px;
            font-weight: 600;
        }

        .markdown-content p {
            margin: 0 0 16px 0;
            line-height: 1.8;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 24px;
            margin: 12px 0;
        }

        .markdown-content li {
            margin: 6px 0;
            line-height: 1.6;
        }

        .markdown-content code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 14px;
            padding: 2px 4px;
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
        }

        .markdown-content pre {
            margin: 16px 0;
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
        }

        .markdown-content pre code {
            display: block;
            padding: 0;
            margin: 0;
            overflow: auto;
            font-size: inherit;
            word-break: normal;
            white-space: pre;
            background: transparent;
            border: 0;
        }

        .markdown-content blockquote {
            margin: 16px 0;
            padding: 0 16px;
            color: #6b7280;
            border-left: 4px solid #e5e7eb;
            background-color: #f8fafc;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #1a56db;
        }

        .markdown-content em {
            color: #4a5568;
            font-style: italic;
        }

        .markdown-content hr {
            height: 2px;
            padding: 0;
            margin: 24px 0;
            background-color: #e5e7eb;
            border: 0;
        }

        .bi-chevron-down, .bi-chevron-up {
            transition: transform 0.3s ease;
        }
        
        #advancedOptionsBtn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #advancedOptionsBtn i {
            margin-left: 5px;
        }

        /* 添加自定义 tooltip 样式 */
        .custom-tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-file-earmark-text me-2"></i>
                文档摘要生成器
            </a>
            <div class="d-flex align-items-center">
                <a href="/admin/users" class="nav-link me-3">
                    <i class="bi bi-people"></i> 用户管理
                </a>
                <a href="/summary_library" class="nav-link me-3">
                    <i class="bi bi-journal-text"></i> 摘要库
                </a>
                <a href="/login" class="nav-link">
                    <i class="bi bi-box-arrow-right"></i> 退出
                </a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar">
            <div class="upload-area mb-4" id="uploadArea">
                <i class="bi bi-cloud-arrow-up upload-icon"></i>
                <div class="upload-text">拖拽文件到这里或点击上传</div>
                <div class="upload-subtext">支持 PDF、Word、TXT、Markdown、EPUB 格式</div>
                <div class="upload-buttons d-flex justify-content-center gap-2">
                    <button class="btn-upload" onclick="handleFileClick()">
                        <i class="bi bi-file-earmark me-1"></i>选择文件
                    </button>
                    <button class="btn-upload" onclick="handleFolderClick()">
                        <i class="bi bi-folder me-1"></i>选择文件夹
                    </button>
                </div>
            </div>
            <div id="filePreviewArea"></div>
            <form id="parameterForm">
                <div class="mb-3">
                    <label for="summaryLength" class="form-label">摘要长度</label>
                    <select class="form-select" id="summaryLength">
                        <option value="very_short">超短摘要 (约100字)</option>
                        <option value="medium" selected>中等摘要 (约500字)</option>
                        <option value="long">详细摘要 (约2000字)</option>
                        <option value="very_long">完整摘要 (约5000字)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="targetLanguage" class="form-label">目标语言</label>
                    <select class="form-select" id="targetLanguage">
                        <option value="chinese" selected>中文</option>
                        <option value="english">英文</option>
                        <option value="japanese">日文</option>
                        <option value="korean">韩文</option>
                        <option value="french">法文</option>
                        <option value="german">德文</option>
                        <option value="spanish">西班牙文</option>
                        <option value="russian">俄文</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-secondary w-100" type="button" 
                            id="advancedOptionsBtn">
                        <i class="bi bi-gear"></i> 高级选项
                        <i class="bi bi-chevron-down ms-2"></i>
                    </button>
                </div>

                <div class="collapse" id="advancedOptions">
                    <div class="card card-body mb-3">
                        <div class="mb-3">
                            <label for="summaryStyle" class="form-label">摘要风格</label>
                            <select class="form-select" id="summaryStyle">
                                <option value="casual" selected>通俗易懂</option>
                                <option value="academic">学术严谨</option>
                                <option value="professional">专业分析</option>
                                <option value="creative">创意概述</option>
                                <option value="journalistic">新闻报道</option>
                                <option value="technical">技术文档</option>
                                <option value="business">商务简报</option>
                                <option value="educational">教育讲解</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="outputFormat" class="form-label">输出格式</label>
                            <select class="form-select" id="outputFormat">
                                <option value="paragraph" selected>连续段落</option>
                                <option value="bullet">要点列表</option>
                                <option value="outline">大纲结构</option>
                                <option value="qa">问答形式</option>
                                <option value="mindmap">思维导图</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="focusArea" class="form-label">关注点</label>
                            <select class="form-select" id="focusArea">
                                <option value="general" selected>综合概述</option>
                                <option value="main_points">主要观点</option>
                                <option value="methodology">方法论</option>
                                <option value="conclusion">结论导向</option>
                                <option value="analysis">分析评价</option>
                                <option value="practical">实践应用</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="expertiseLevel" class="form-label">专业程度</label>
                            <select class="form-select" id="expertiseLevel">
                                <option value="beginner" selected>入门级</option>
                                <option value="intermediate">进阶</option>
                                <option value="advanced">专家级</option>
                                <option value="expert">权威级</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="languageStyle" class="form-label">语言风格</label>
                            <select class="form-select" id="languageStyle">
                                <option value="neutral" selected>中性客观</option>
                                <option value="formal">正式严谨</option>
                                <option value="informal">轻松活泼</option>
                                <option value="professional">专业术语</option>
                                <option value="simple">简单直白</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>
                    <span class="spinner-border spinner-border-sm" id="loadingSpinner" role="status" hidden></span>
                    <span class="btn-text">生成摘要</span>
                </button>
            </form>
        </div>
        <div class="main-content">
            <div class="container-fluid p-4">
                <div id="chatBody" class="markdown-content">
                    <!-- 内容将通过JavaScript动态插入 -->
                </div>
            </div>
        </div>
    </div>

    <div id="error-message" class="hidden fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50" role="alert">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        // 全局变量
        let selectedFiles = [];
        const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        const filePreviewArea = document.getElementById('filePreviewArea');
        const submitBtn = document.getElementById('submitBtn');

        // 文件大小格式化
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
                const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 获取文件图标
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'bi-file-pdf',
                'docx': 'bi-file-word',
                'doc': 'bi-file-word',
                'txt': 'bi-file-text',
                'md': 'bi-markdown',
                'epub': 'bi-book'
            };
            return icons[extension] || 'bi-file-earmark';
        }

        // 处理文件选择按钮点击
        function handleFileClick() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.pdf,.docx,.doc,.txt,.md,.epub';
            
            input.addEventListener('change', handleFileSelect);
            input.click();
        }

        // 处理文件夹选择按钮点击
        function handleFolderClick() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.webkitdirectory = true;
            input.directory = true;
            
            input.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFolderSelect(files);
            });
            input.click();
        }

        // 处理文件夹选择
        function handleFolderSelect(files) {
            console.log('选择的所有文件:', files);

            const allFiles = Array.from(files);
            const validFiles = [];
            const invalidFiles = [];
            
            allFiles.forEach(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                if (['pdf', 'docx', 'doc', 'txt', 'md', 'epub'].includes(extension)) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push(file);
                }
            });

            console.log('有效的文件:', validFiles);
            console.log('不支持的文件:', invalidFiles);

            if (validFiles.length === 0) {
                const message = invalidFiles.length > 0 
                    ? `文件夹中的 ${invalidFiles.length} 个文件格式不受支持（仅支持 PDF、Word、TXT、Markdown、EPUB 格式）`
                    : '文件夹为空';
                showError(message);
                    return;
                }

            // 过滤掉重复的文件
            const uniqueFiles = validFiles.filter(file => !isFileExists(file));
            const duplicateFiles = validFiles.filter(file => isFileExists(file));

            if (uniqueFiles.length === 0) {
                const message = duplicateFiles.length > 0
                    ? '所选文件都已存在'
                    : '没有新的文件可以添加';
                showError(message);
                return;
            }

            // 将新的非重复文件添加到现有文件列表中
            selectedFiles = selectedFiles.concat(uniqueFiles);
            
            // 重新排序文件列表
            selectedFiles.sort((a, b) => {
                const pathA = (a.webkitRelativePath || a.name).toLowerCase();
                const pathB = (b.webkitRelativePath || b.name).toLowerCase();
                return pathA.localeCompare(pathB);
            });

            // 显示处理结果
            let statusMessage = '';
            if (invalidFiles.length > 0) {
                statusMessage += `<div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${invalidFiles.length} 个文件格式不受支持
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
            if (duplicateFiles.length > 0) {
                statusMessage += `<div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    ${duplicateFiles.length} 个文件已存在，已跳过
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
            if (uniqueFiles.length > 0) {
                statusMessage += `<div class="alert alert-success alert-dismissible fade show mb-2" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    成功添加 ${uniqueFiles.length} 个文件
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }
            
            updateFilePreview(selectedFiles, statusMessage);
                    submitBtn.disabled = false;
        }

        // 检查文件是否已存在
        function isFileExists(newFile) {
            return selectedFiles.some(existingFile => {
                // 获取完整的文件路径
                const newFilePath = (newFile.webkitRelativePath || newFile.name).toLowerCase();
                const existingFilePath = (existingFile.webkitRelativePath || existingFile.name).toLowerCase();
                
                // 如果文件路径完全相同，则认为是重复文件
                if (newFilePath === existingFilePath) {
                    return true;
                }
                
                // 如果文件名和大小都相同，也认为是重复文件
                const newFileName = newFile.name.toLowerCase();
                const existingFileName = existingFile.name.toLowerCase();
                return newFileName === existingFileName && newFile.size === existingFile.size;
            });
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            console.log('选择的文件:', files); // 调试日志

            if (e.target.webkitdirectory) {
                handleFolderSelect(files);
                return;
            }

            const validFiles = files.filter(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                return ['pdf', 'docx', 'doc', 'txt', 'md', 'epub'].includes(extension);
            });

            if (validFiles.length === 0) {
                showError('没有选择支持的文件格式');
                return;
            }

            // 过滤掉重复的文件
            const uniqueFiles = validFiles.filter(file => !isFileExists(file));
            
            if (uniqueFiles.length === 0) {
                showError('所选文件已经存在');
                return;
            }

            // 将新的非重复文件添加到现有文件列表中
            selectedFiles = selectedFiles.concat(uniqueFiles);
            
            // 重新排序文件列表
            selectedFiles.sort((a, b) => {
                const pathA = (a.webkitRelativePath || a.name).toLowerCase();
                const pathB = (b.webkitRelativePath || b.name).toLowerCase();
                return pathA.localeCompare(pathB);
            });
            
            updateFilePreview(selectedFiles);
            submitBtn.disabled = false;
        }

        // 更新文件预览
        function updateFilePreview(files, statusMessage = '') {
            let previewHtml = statusMessage;
            
            files.forEach((file, index) => {
                const fileSize = formatFileSize(file.size);
                const fileIcon = getFileIcon(file.name);
                const filePath = file.webkitRelativePath || file.name;
                
                previewHtml += `
                    <div class="file-preview" id="file-${index}">
                        <div class="file-preview-header">
                            <div class="file-preview-info">
                                <i class="bi ${fileIcon} file-icon"></i>
                                <div class="file-preview-title" 
                                     onmouseover="showTooltip(event, '${filePath}')"
                                     onmouseout="hideTooltip(event)"
                                     onmousemove="moveTooltip(event)">${filePath}</div>
                                <div class="file-preview-size">${fileSize}</div>
                            </div>
                            <button class="file-preview-remove" onclick="removeFile(${index})" title="移除">
                                <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });

            filePreviewArea.innerHTML = previewHtml;
        }

        // 移除文件
        function removeFile(index) {
            selectedFiles = selectedFiles.filter((_, i) => i !== index);
            document.getElementById(`file-${index}`).remove();
            
            if (selectedFiles.length === 0) {
                submitBtn.disabled = true;
                filePreviewArea.innerHTML = '';
            }
        }

        // 显示错误信息
        function showError(message) {
            const errorHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            filePreviewArea.innerHTML = errorHtml;
        }

        // 拖拽相关事件处理
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('drag-over');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('drag-over');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
            
            const items = e.dataTransfer.items;
            const files = [];
            
            // 递归获取所有文件
            async function getAllFiles(item) {
                if (item.isFile) {
                    const file = await new Promise((resolve) => item.file(resolve));
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (['pdf', 'docx', 'doc', 'txt', 'md', 'epub'].includes(extension)) {
                        // 检查文件是否已存在
                        if (!isFileExists(file)) {
                            files.push(file);
                        }
                    }
                } else if (item.isDirectory) {
                    const reader = item.createReader();
                    const entries = await new Promise((resolve) => reader.readEntries(resolve));
                    for (const entry of entries) {
                        await getAllFiles(entry);
                    }
                }
            }

            // 处理所有拖放的项目
            Promise.all(Array.from(items).map(item => getAllFiles(item.webkitGetAsEntry()))).then(() => {
                if (files.length === 0) {
                    showError('没有找到新的支持格式的文件');
                    return;
                }
                
                selectedFiles = selectedFiles.concat(files);
                updateFilePreview(selectedFiles);
                submitBtn.disabled = false;
            });

            unhighlight(e);
        }

        // 表单提交处理
        document.getElementById('parameterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedFiles.length === 0) {
                showError('请先选择要处理的文件');
                return;
            }

            const loadingSpinner = document.getElementById('loadingSpinner');
            const btnText = document.querySelector('.btn-text');
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                loadingSpinner.hidden = false;
                btnText.textContent = '处理中...';
                submitBtn.disabled = true;

                // 创建 FormData 对象
                const formData = new FormData();
                
                // 添加参数
                formData.append('summary_length', document.getElementById('summaryLength').value);
                formData.append('target_language', document.getElementById('targetLanguage').value);
                formData.append('summary_style', document.getElementById('summaryStyle').value);
                formData.append('focus_area', document.getElementById('focusArea').value);
                formData.append('expertise_level', document.getElementById('expertiseLevel').value);
                formData.append('language_style', document.getElementById('languageStyle').value);

                // 添加所有选中的文件
                for (let i = 0; i < selectedFiles.length; i++) {
                    formData.append('file', selectedFiles[i]);
                }

                // 发送请求
                const response = await fetch('/process_document', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '处理文件时发生错误');
                }

                const result = await response.json();
                
                // 清空文件列表
                selectedFiles = [];
                filePreviewArea.innerHTML = '';
                submitBtn.disabled = true;

                // 显示处理结果
                const chatBody = document.getElementById('chatBody');
                let resultHtml = '<div class="markdown-body">';

                // 处理每个文件的结果
                result.results.forEach(fileResult => {
                    resultHtml += `
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi ${getFileIcon(fileResult.filename)}"></i>
                                    ${fileResult.filename}
                                </h5>
                            </div>
                            <div class="card-body">
                                ${fileResult.success 
                                    ? `<div class="summary-content">${fileResult.summary}</div>`
                                    : `<div class="alert alert-danger">${fileResult.error}</div>`
                                }
                            </div>
                        </div>
                    `;
                });

                resultHtml += '</div>';
                chatBody.innerHTML = resultHtml;

                // 显示成功消息
                const successMessage = `
                    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        已完成 ${result.results.length} 个文件的处理
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                filePreviewArea.innerHTML = successMessage;

            } catch (error) {
                showError(error.message || '处理文件时发生错误');
            } finally {
                loadingSpinner.hidden = true;
                btnText.textContent = '生成摘要';
                submitBtn.disabled = false;
            }
        });

        // 创建 tooltip 元素
        const tooltip = document.createElement('div');
        tooltip.className = 'custom-tooltip';
        document.body.appendChild(tooltip);

        // 显示 tooltip
        function showTooltip(event, text) {
            tooltip.textContent = text;
            tooltip.style.opacity = '1';
            tooltip.style.visibility = 'visible';
            moveTooltip(event);
        }

        // 隐藏 tooltip
        function hideTooltip(event) {
            tooltip.style.opacity = '0';
            tooltip.style.visibility = 'hidden';
        }

        // 移动 tooltip
        function moveTooltip(event) {
            const padding = 10;
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            
            let x = event.pageX + padding;
            let y = event.pageY + padding;

            // 确保 tooltip 不会超出窗口右边界
            if (x + tooltipWidth > window.innerWidth) {
                x = window.innerWidth - tooltipWidth - padding;
            }

            // 确保 tooltip 不会超出窗口下边界
            if (y + tooltipHeight > window.innerHeight) {
                y = event.pageY - tooltipHeight - padding;
            }

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }
    </script>
</body>
</html>